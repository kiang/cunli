<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">

        <!--[if lt IE 9]>
          <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <style type="text/css">
            html, body, #map_canvas { height: 100%; margin: 0;}
            body{
                padding-top:50px; /*padding for navbar*/
            }

            .navbar-custom .icon-bar {
                background-color:#fff;
            }

            .navbar-custom {
                background-color: #168ccc;
                color:#fff;
            }

            .navbar-custom li>a:hover,.navbar-custom li>a:focus {
                background-color:#49bfff;
            }

            .navbar-custom a{
                color:#fefefe;
            }

            .navbar-custom .form-control:focus {
                border-color: #49bfff;
                outline: 0;
                -webkit-box-shadow: inset 0 0 0;
                box-shadow: inset 0 0 0;
            }
			#map-wrap{ 
				position:relative;
				width:100%; 
				height:100%;
			}
			#map_info{
				position:absolute;
				top: 40px;
				right: 0;
				width:200px;
				height:60px;
				border: 1px solid #ff0000;
				z-index:10;
			}
			
			#map_canvas{
				border:1px solid #f00;
			}
			
			
            .labelCunli {
                color: #f83358;
				padding: 1px 2px; 
				background-color: #fef3fb;
				border: 1px solid #000;
				border-radius: 12px;
				text-align: center;
				font-size: 12pt;
				width: 66px;
            }
			.labelCunli-hover{
				background-color: #fab4e4;
            }
        </style>
    </head>
    <body onload="initialize()">
        <div class="navbar navbar-custom navbar-fixed-top">
            <div class="navbar-header"><a class="navbar-brand" href="#">村里</a>
                <a class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">Home</a></li>
                    <li><a href="#">Link</a></li>
                    <li><a href="#">Link</a></li>
                    <li>&nbsp;</li>
                </ul>
                <form class="form-inline" style="padding: 8px;">
                    <select class="form-control select-county">
                        <option value="0">縣市</option>
                    </select>
                    <select class="form-control select-town">
                        <option value="0">鄉鎮市區</option>
                    </select>
                </form>
            </div>
        </div>
		<div id="map-wrap">
			<div id="map_info">Village Infomation</div>
			<div id="map_canvas"></div>
		</div>
        <script src="GeoJSON.js"></script>
        <script src="topojson.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
        <script src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script type='text/javascript' src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <script>
		var map = null;
        initialize = function() {
            var mapOptions = {
                center: new google.maps.LatLng(21.896710512476858, 119.3151574766245),
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            map = new google.maps.Map(document.getElementById("map_canvas"),
                    mapOptions);

            var listInfo = [];
            var overlays = [];
			

			google.maps.event.addListener(map, 'zoom_changed', function() {
				var zoomLevel = map.getZoom();				
				if (zoomLevel < 15) {	
					$.each(overlays, function(i, v){	
						if(!(v instanceof InfoBox)){
							v.setMap(null);
						}
					});
				} else {
					$.each(overlays, function(i, v){	
						if(!(v instanceof InfoBox)){
							v.setMap(map);
						}
					});
				}
			});
						
            $.getJSON('json/list.json', function(data) {
                listInfo = data;
                var countySelect = $('select.select-county');
                countySelect.html('');

                $.each(listInfo.counties, function(k, v) {
                    $('<option>').val(k).html(v).appendTo(countySelect);
                });

                countySelect.change(function() {
                    var selectedCountyId = $(this).val();
                    var townSelect = $('select.select-town');
                    townSelect.html('');
                    $.each(listInfo.county2towns[selectedCountyId], function(k, v) {
                        $('<option>').val(v).html(listInfo.towns[v]).appendTo(townSelect);
                    });
                    townSelect.trigger('change');
                });

                countySelect.trigger('change');
            });
			
			var cunliHandler ={
				click: function(){
					//console.log(this);
					map.setCenter(this.center);
					$('#map-info').append($("<pre/>").text(console.log(this.geojsonProperties, true)))
				},
				mouseOver:function() {
					console.log("cunliPoint over");
					this.strokeWeight = 10;
					this.strokeColor = "#FF0000";

					//repaint, trigger resize didn't work 
					this.setMap(null);
					this.setMap(map);	
				},
				mouseOut:function() {
					console.log("cunliPoint out", this);
					this.strokeWeight = 1;
					this.strokeColor = "#0000FF";
					var zoomlevel = this.map?this.map.zoom:14;
					
					//repaint, trigger resize didn't work 
					this.setMap(null);
					//this.setMap(map);
					if(zoomlevel >= 15) { //fix for zoomout 
						this.setMap(map);
					}					
				}
			}; //end cunli

			

            $('select.select-town').change(function() {
                var selectedCountyId = $('select.select-county').val();
                var selectedTownId = $(this).val();

                if (selectedTownId !== '' && selectedTownId != '0') {
                    $.getJSON('json/' + selectedCountyId + '_' + selectedTownId + '.json', function(data) {
                        var cunli_geojson = topojson.feature(data, data.objects.layer1).features;
                        var bounds = new google.maps.LatLngBounds;
						var townBounds = new google.maps.LatLngBounds;
                        var style = {
                            strokeColor: "#0000FF",
                            strokeWeight: 1,
                            strokeOpacity: 0.45,
                            fillOpacity: 0.1,
                        };
	
						//clean overlay
                        $.each(overlays, function(k, v) {
                            v.setMap(null);
                        });
                        overlays = [];

                        var pushPolygon = function(cunliPoint, k) {
                            var i = cunliPoint.latLngs.getArray();

                            var labelBounds = new google.maps.LatLngBounds;

                            for (lk in i['0']['j']) {
                                labelBounds.extend(i['0']['j'][lk]);
                            }

                            var myOptions = {
                                content: cunli_geojson[k].properties.VILLAGE
                                , boxClass: 'labelCunli'
                                , disableAutoPan: true
                                , pixelOffset: new google.maps.Size(-25, 0)
                                , position: labelBounds.getCenter()
                                , closeBoxURL: ""
                                , isHidden: false
                                , pane: "mapPane"
                                , enableEventPropagation: true
                            };

                            var ibLabel = new InfoBox(myOptions);
                            ibLabel.open(map);
                            overlays.push(ibLabel);

                            bounds.extend(labelBounds.getCenter());
							cunliPoint.center = labelBounds.getCenter();
							if(map.zoom < 15) {
								cunliPoint.setMap(null);
							}else {
								cunliPoint.setMap(map);
							}
                            overlays.push(cunliPoint);
							google.maps.event.addListener(cunliPoint, 'click', cunliHandler.click);
							google.maps.event.addListener(cunliPoint, 'mouseover', cunliHandler.mouseOver );
							google.maps.event.addListener(cunliPoint, 'mouseout', cunliHandler.mouseOut);

                        }

                        $.each(cunli_geojson, function(k, v) {
                            var cunli = new GeoJSON(cunli_geojson[k], style);
                            if (typeof cunli.setMap === 'function') {
                                pushPolygon(cunli, k);
                            } else if (null !== cunli_geojson[k].geometry) {
                                //MultiPolygon
                                for(mk in cunli) {
                                    pushPolygon(cunli[mk], k);
                                }
                            }
                        });
                        map.setCenter(bounds.getCenter());
                    });
                }
            });

        }
        </script>
    </body>
</html>